# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-4.3.0/charts/other/app-template/values.schema.json

## This chart relies on the common library chart from bjw-s-labs
## You can find it at https://github.com/bjw-s-labs/helm-charts/tree/main/charts/library/common
## Refer there for more detail about the supported values

# Internal image configuration - managed by the chart
# Users should not override this unless they know what they're doing
image:
  repository: ghcr.io/immich-app/immich-server
  tag: v2.2.1

immich:
  # configuration is immich-config.json converted to yaml
  # ref: https://immich.app/docs/install/config-file/
  # This configuration is applied to the immich-config.yaml file
  # and mounted to both server and machine-learning containers
  #
  # Set to {} (empty) to use Immich's internal defaults (default, recommended for GitOps).
  # Set to null to manage configuration via the Immich web GUI.
  # Set specific values to override defaults with declarative configuration (for GitOps).
  # Any Object { key: value } is merged with Immich's internal defaults.
  configuration: {}
  # Example chart-managed configuration, a more detailed example is in the full-features.yaml example:
  # configuration:
  #   trash:
  #     enabled: true
  #     days: 30
  #   notifications:
  #     smtp:
  #       enabled: true
  #       from: 'Immich <noreply@example.com>'
  #       replyTo: ''
  #       transport:
  #         host: 'smtp.example.com'
  #         ignoreCert: false
  #         password: 'TODOCHANGEME'
  #         port: 587
  #         username: 'noreply@example.com'

  # Machine Learning configuration
  machineLearning:
    # Enable or disable the ML service
    # Set to false to disable ML features (face detection, object recognition, etc.)
    enabled: true

  # Monitoring configuration
  # Enable to expose Prometheus metrics endpoints and create ServiceMonitor
  monitoring:
    enabled: false

  # Database configuration
  database:
    # Storage type for bundled PostgreSQL: 'hdd' or 'ssd'
    # Controls PostgreSQL optimization settings
    storageType: hdd

    # External database connection (requires postgresql.enabled: false)
    # When using bundled PostgreSQL, set password at postgresql.auth.password instead
    # host: "postgres.example.com"
    # port: 5432
    # username: "immich"
    # name: "immich"
    # password: "your-password"
    # Or use secret reference:
    # password:
    #   valueFrom:
    #     secretKeyRef:
    #       name: immich-db-secret
    #       key: password

  # Redis configuration
  # For external Redis, set redis.enabled: false and configure connection below
  redis: {}
  #   host: "redis.example.com"
  #   port: 6379

# Persistence configuration
persistence:
  library:
    type: persistentVolumeClaim
    # existingClaim: "name-of-existing-claim"
    storageClass: null
    accessMode: ReadWriteOnce
    size: 100Gi
    advancedMounts:
      server:
        main:
          - path: /data
  external:
    type: persistentVolumeClaim
    # existingClaim: "name-of-existing-claim"
    storageClass: null
    accessMode: ReadWriteOnce
    size: 10Gi
    advancedMounts:
      server:
        main:
          - path: /usr/src/app/external
  machine-learning-cache:
    type: persistentVolumeClaim
    # Optional: Set type to emptyDir to stop caching between pod restarts
    # type: emptyDir
    # existingClaim: "name-of-existing-claim"
    storageClass: null
    accessMode: ReadWriteOnce
    size: 10Gi
    advancedMounts:
      machine-learning:
        main:
          - path: /cache

# Ingress configuration (disabled by default)
ingress:
  server:
    enabled: false
    annotations:
      nginx.ingress.kubernetes.io/proxy-body-size: '0'
    hosts:
      - host: immich.local
        paths:
          - path: '/'
    tls: []

# Dependencies - PostgreSQL and Redis
# Set enabled: false to use external services
# When disabled, configure connection details in immich.database / immich.redis above
postgresql:
  enabled: true
  # Internal image configuration - managed by the chart
  # Users should not override this unless they know what they're doing
  image:
    registry: ghcr.io
    repository: immich-app/postgres
    tag: 14-vectorchord0.3.0-pgvectors0.3.0
  auth:
    # Disable postgres superuser to prevent ArgoCD drift from random postgres-password
    # Init scripts run as 'immich' user which has sufficient privileges
    enablePostgresUser: false
    # REQUIRED: Set password for bundled PostgreSQL
    # This password is used by both PostgreSQL and the Immich application
    #
    # Option 1: Direct password
    password: null # CHANGE THIS!
    #
    # Option 2: Reference an existing secret
    # Create a secret with a key named 'password':
    #   kubectl create secret generic immich-postgresql-secret \
    #     --from-literal=password='YOUR-SECURE-PASSWORD'
    # Then uncomment:
    # existingSecret: immich-postgresql-secret
  global:
    postgresql:
      auth:
        username: immich
        database: immich
        # Password is already set above in postgresql.auth.password
    security:
      allowInsecureImages: true
  primary:
    # Environment variables for PostgreSQL
    # Will be merged with ConfigMap created by templates/postgresql-env-configmap.yaml
    # Override any of these or add custom vars - they merge with defaults defined here
    env:
      POSTGRES_DB: immich
      POSTGRESQL_STARTUP_TIMEOUT: '256'
    extraEnvVarsCM: immich-postgresql-env
    customLivenessProbe:
      tcpSocket:
        port: tcp-postgresql
    customReadinessProbe:
      tcpSocket:
        port: tcp-postgresql
    customStartupProbe:
      tcpSocket:
        port: tcp-postgresql
      failureThreshold: 256
    persistence:
      enabled: true
      accessMode: ReadWriteOnce
      size: 20Gi
      storageClass: null
    resources:
      requests:
        memory: '512Mi'
      limits:
        memory: '2Gi'
    initdb:
      scripts:
        # This should be unnecessary as we set the POSTGRES_DB env var, but for some reason sometimes the DB is not created
        01-create-db.sql: |
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT FROM pg_database WHERE datname = 'immich'
            ) THEN
              CREATE DATABASE immich OWNER immich;
            END IF;
          END
          $$;
        02-create-extensions.sql: |
          CREATE EXTENSION cube;
          CREATE EXTENSION earthdistance;
          CREATE EXTENSION vectors;
    containerSecurityContext:
      readOnlyRootFilesystem: false

redis:
  enabled: true
  # Use standalone architecture (single instance, no replicas)
  architecture: standalone
  # Disable auth for internal Redis (auth is typically only needed for external Redis)
  auth:
    enabled: false
  # Disable persistence for internal Redis (ephemeral cache is sufficient)
  master:
    persistence:
      enabled: false
